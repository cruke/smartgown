<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Convocation Robe Borrowing System</title>
<style>
:root { --bg:#0f172a; --fg:#e2e8f0; --accent:#22d3ee; --blue:#22d3ee; --red:#ef4444; }
*{box-sizing:border-box}
body{margin:0;background:#0f172a;color:#e2e8f0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
header{
  position:sticky;top:0;z-index:999;
  padding:14px 16px;background:#111827;border-bottom:2px solid var(--accent);
  text-align:center;font-size:20px;font-weight:600;color:var(--accent);
}
main{padding:12px 16px;max-width:900px;margin:auto}
button{background:#111827;color:var(--fg);border:1px solid #374151;border-radius:10px;padding:8px 14px;margin:2px;cursor:pointer}
button:hover{border-color:var(--accent)}
label{margin-right:10px}
fieldset{border:1px solid #334155;padding:8px 12px;border-radius:8px;margin-top:8px}
legend{font-size:14px;color:var(--accent)}
#frameWrap{position:relative;border:1px solid #334155;border-radius:12px;overflow:hidden;background:#000;margin:10px 0}
#video{display:none}
#view{display:block;width:100%;height:auto}
#overlay{position:absolute;left:0;top:0;width:100%;height:auto;pointer-events:none}
#statusLabel{text-align:center;margin-top:8px;font-size:15px;color:var(--accent)}
#summaryLine{text-align:center;margin-top:10px;font-size:16px;color:#9fe8a3;font-weight:500;}
.badge{position:absolute;left:10px;top:10px;background:rgba(0,0,0,.6);padding:6px 10px;border-radius:999px;font-size:12px}
</style>

<!-- ZXing -->
<script type="module">
import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm";
window.ZXING_Reader = new BrowserMultiFormatReader();
</script>
</head>
<body>
<header>üéì Smart Convocation Robe Borrowing System</header>
<main>
<div>
  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>
  <button id="torchBtn" disabled>Torch</button>
  <button id="testBtn">Test System</button>
  <label><input type="checkbox" id="beepChk" checked> Beep</label>
  <label><input type="checkbox" id="vibrateChk" checked> Vibrate</label>
  <label><input type="checkbox" id="mirrorChk"> Mirror camera view</label>
  <label><input type="checkbox" id="preventDupesChk" checked> Prevent duplicate send</label>
  <span id="tgStatus" style="margin-left:10px">Telegram: idle</span>
</div>

<fieldset>
  <legend>Mode Selection</legend>
  <label><input type="radio" name="mode" value="borrow" checked> Borrow</label>
  <label><input type="radio" name="mode" value="return"> Return</label>
</fieldset>

<div id="frameWrap">
  <div id="modeBadge" class="badge">Mode: BORROW</div>
  <video id="video" playsinline></video>
  <canvas id="view"></canvas>
  <canvas id="overlay"></canvas>
</div>
<div id="statusLabel">Ready.</div>
<div id="summaryLine"></div>
</main>

<script type="module">
/* ==== CONFIG ==== */
const GAS_URL  = "https://script.google.com/macros/s/AKfycbyJifwYjoBeZ0SmFc7F7ENJCQfTuquT6QVZHV4aCEfamgFQmtED78IWLeOqSPnXGCo/exec";
const BOT_TOKEN= "121011557:AAHE32VqMkQ8AnnXuDAlLXZn6Ybg7mXpyMo";
const CHAT_ID  = "44305665";
const BLOCK_MS = 5000;

/* ==== DOM ==== */
const video=document.getElementById("video"), view=document.getElementById("view"), vctx=view.getContext("2d");
const overlay=document.getElementById("overlay"), ctx=overlay.getContext("2d");
const startBtn=document.getElementById("startBtn"), stopBtn=document.getElementById("stopBtn");
const torchBtn=document.getElementById("torchBtn");
const testBtn=document.getElementById("testBtn");
const beepChk=document.getElementById("beepChk"), vibrateChk=document.getElementById("vibrateChk");
const mirrorChk=document.getElementById("mirrorChk"), preventDupesChk=document.getElementById("preventDupesChk");
const statusLabel=document.getElementById("statusLabel"), tgStatus=document.getElementById("tgStatus");
const modeBadge=document.getElementById("modeBadge"), summaryLine=document.getElementById("summaryLine");

/* ==== STATE ==== */
let stream=null, track=null, facing="environment";
let decoderRunning=false, renderRunning=false, audioCtx;
let vw=0,vh=0,cropY=0,cropH=0;
const codeReader=window.ZXING_Reader;
const scannedByMode={borrow:new Set(),return:new Set()}, processedAt=new Map();
let lastFrameKey="",lastFrameTime=0,lastDet=null,lastDetTime=0;

/* ==== Mode ==== */
function getMode(){return document.querySelector('input[name="mode"]:checked').value;}
document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change',()=>modeBadge.textContent="Mode: "+getMode().toUpperCase()));

/* ==== Helpers ==== */
function beep(){if(!beepChk.checked)return;audioCtx??=new (window.AudioContext||window.webkitAudioContext)();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type="sine";o.frequency.value=880;o.connect(g);g.connect(audioCtx.destination);o.start();setTimeout(()=>o.stop(),100);}
function flash(){document.body.style.background="#334";setTimeout(()=>document.body.style.background="#0f172a",150);}
function keyFor(m,t){return`${m}||${t}`;}function isBlocked(m,t){const k=keyFor(m,t);return(Date.now()-(processedAt.get(k)||0))<BLOCK_MS;}

/* ==== Camera ==== */
async function start(){
 stop();
 try{
   stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}});
   video.srcObject=stream;await video.play();track=stream.getVideoTracks()[0];
   torchBtn.disabled=!track.getCapabilities?.().torch;
   startBtn.disabled=true;stopBtn.disabled=false;updateSizes();startDecode();startRender();
   statusLabel.textContent="Camera started.";
 }catch(e){statusLabel.textContent=e.message;}
}
function stop(){if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
 startBtn.disabled=false;stopBtn.disabled=true;torchBtn.disabled=true;
 stopDecode();stopRender();vctx.clearRect(0,0,view.width,view.height);ctx.clearRect(0,0,overlay.width,overlay.height);}
async function toggleTorch(){if(!track)return;const caps=track.getCapabilities?.()||{};if(!caps.torch)return;const cur=track.getConstraints().torch;try{await track.applyConstraints({advanced:[{torch:!cur}]});}catch(e){console.warn(e);}}

/* ==== Sizing ==== */
function updateSizes(){vw=video.videoWidth||640;vh=video.videoHeight||480;cropY=Math.floor(vh/3);cropH=Math.floor(vh/3);
 view.width=vw;view.height=cropH;overlay.width=vw;overlay.height=cropH;view.style.width="100%";overlay.style.width="100%";}
video.addEventListener('loadedmetadata',updateSizes);

/* ==== Render ==== */
function startRender(){if(renderRunning)return;renderRunning=true;(function loop(){if(!renderRunning)return;requestAnimationFrame(loop);
 if(!vw||!vh)return;vctx.save();if(mirrorChk.checked){vctx.translate(view.width,0);vctx.scale(-1,1);}vctx.drawImage(video,0,cropY,vw,cropH,0,0,view.width,view.height);vctx.restore();
 ctx.clearRect(0,0,overlay.width,overlay.height);
 if(lastDet&&(performance.now()-lastDetTime)<200)drawDet(lastDet);})();}function stopRender(){renderRunning=false;}
function mapPoint(p){let x=p.getX?p.getX():p.x,y=p.getY?p.getY():p.y;if(mirrorChk.checked)x=vw-x;y-=cropY;return{x,y};}
function drawDet(det){const pts=det.points.map(mapPoint).filter(p=>p.y>=0&&p.y<=cropH);if(!pts.length)return;
 let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;for(const p of pts){minX=Math.min(minX,p.x);maxX=Math.max(maxX,p.x);minY=Math.min(minY,p.y);maxY=Math.max(maxY,p.y);}
 const pad=20,x=Math.max(0,minX-pad),y=Math.max(0,minY-pad),w=Math.min(overlay.width,maxX+pad)-x,h=Math.min(overlay.height,maxY+pad)-y;
 ctx.lineWidth=4;ctx.strokeStyle=det.color;ctx.strokeRect(x,y,w,h);ctx.font="16px system-ui";const tw=ctx.measureText(det.label).width;ctx.fillStyle="rgba(0,0,0,0.6)";
 ctx.fillRect(x-4,Math.max(0,y-24),tw+10,20);ctx.fillStyle=det.color;ctx.fillText(det.label,x,y-8);}

/* ==== Decode ==== */
function startDecode(){if(decoderRunning)return;decoderRunning=true;codeReader.decodeFromVideoDevice(null,video,(res,err,ctrl)=>{
 if(!decoderRunning){ctrl?.stop();return;}if(res){handleDet(res.getText?res.getText():res.text,res.getResultPoints?res.getResultPoints():res.resultPoints||[]);}});}
function stopDecode(){decoderRunning=false;try{codeReader.reset();}catch{}}

/* ==== Detection ==== */
async function handleDet(text,points){
 const mode=getMode(),recent=isBlocked(mode,text),dupe=scannedByMode[mode].has(text);
 const color=getComputedStyle(document.documentElement).getPropertyValue((recent||dupe)?'--red':'--blue').trim();
 const label=recent?`Blocked ${mode}`:(dupe?`Duplicate ${mode}`:text);
 lastDet={points,color,label};lastDetTime=performance.now();
 const key=keyFor(mode,text),now=Date.now();if(key===lastFrameKey&&(now-lastFrameTime)<1200)return;lastFrameKey=key;lastFrameTime=now;
 if(recent){statusLabel.textContent=`‚õî Blocked (${mode})`;return;}
 if(preventDupesChk.checked)processedAt.set(key,now);
 flash();beep();if(vibrateChk.checked&&navigator.vibrate)navigator.vibrate(80);
 statusLabel.textContent=`‚è≥ Sending (${mode.toUpperCase()})...`;
 const snap=await captureSnap(),caption=`üì∑ ${mode.toUpperCase()} Scan\n‚Ä¢ Data: ${text}\n‚Ä¢ Time: ${new Date().toLocaleString()}`;
 try{
   const s=await sendSheet(text,snap,mode),t=await sendTg(snap,caption);
   statusLabel.textContent=(s.ok?"‚úÖ Sheet ":"‚ùå Sheet ")+(t.ok?"| ‚úÖ Telegram":"| ‚ùå Telegram");
   if(s.ok){scannedByMode[mode].add(text);await updateSummaryFromSheet(text,mode);}
 }catch(e){statusLabel.textContent="‚ùå "+e.message;}
}

/* ==== Capture ==== */
async function captureSnap(){const c=document.createElement('canvas');c.width=view.width;c.height=view.height;const cx=c.getContext('2d');
 if(mirrorChk.checked){cx.translate(c.width,0);cx.scale(-1,1);}cx.drawImage(video,0,cropY,vw,cropH,0,0,c.width,c.height);
 return new Promise(r=>c.toBlob(b=>r(b),'image/png',0.95));}
function blobToDataURL(b){return new Promise(r=>{const f=new FileReader();f.onload=()=>r(f.result);f.readAsDataURL(b);});}

/* ==== Network ==== */
async function sendSheet(id,blob,mode){
  const img=blob?await blobToDataURL(blob):"";
  const body={mode,id,qr:id,url:location.href,image:img};
  const r=await fetch(GAS_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(body)});
  const t=await r.text();try{return JSON.parse(t);}catch{return{ok:false,error:t}};
}
async function sendTg(blob,caption){
  try{
    tgStatus.textContent="Telegram: sending...";
    const fd=new FormData();fd.append("chat_id",CHAT_ID);fd.append("caption",caption);fd.append("photo",blob,"frame.png");
    const r=await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`,{method:"POST",body:fd});
    const j=await r.json();tgStatus.textContent=j.ok?"Telegram: ‚úÖ":"Telegram: ‚ùå";return j;
  }catch(e){tgStatus.textContent="Telegram: ‚ùå";return{ok:false,error:e.message};}
}

/* ==== Test System (NO APPEND TO SHEET) ==== */
testBtn.onclick=async()=>{
  statusLabel.textContent="üîÑ Testing system...";
  try{
    const blob=await captureSnap();
    let sheetOk=false;
    try{
      const r=await fetch(GAS_URL+"?action=ping",{method:"GET"});
      const txt=await r.text();try{const j=JSON.parse(txt);sheetOk=!!j.ok;}catch{sheetOk=/"ok"\s*:\s*true/.test(txt);}
    }catch{sheetOk=false;}
    const cap=`üß™ System Test\n‚Ä¢ Time: ${new Date().toLocaleString()}\n‚Ä¢ Note: Sheet ping only (no append)`;
    const tg=await sendTg(blob,cap);
    statusLabel.textContent=(sheetOk?"üü¢ Sheet OK ":"üî¥ Sheet Fail ")+(tg.ok?"| üü¢ Telegram OK":"| üî¥ Telegram Fail");
  }catch(e){statusLabel.textContent="‚ùå "+e.message;}
};

/* ==== Fetch Name & Update Summary ==== */
async function updateSummaryFromSheet(id, mode){
  try{
    const r=await fetch(`${GAS_URL}?action=getlatest&id=${encodeURIComponent(id)}`);
    const j=await r.json();
    if(j.ok && j.row){
      const personName=j.row.name||"Unknown";
      const now=new Date().toLocaleString();
      const action=mode.toUpperCase();
      summaryLine.innerHTML=`${personName} (${id}) <b>${action}ED</b> a robe at ${now}`;
    } else {
      summaryLine.textContent=`(${id}) ${mode.toUpperCase()} completed.`;
    }
  }catch{
    summaryLine.textContent=`(${id}) ${mode.toUpperCase()} completed.`;
  }
}

/* ==== Bindings ==== */
startBtn.onclick=start;stopBtn.onclick=stop;torchBtn.onclick=toggleTorch;
</script>
</body>
</html>
